<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Плейлист через JWT + Range</title>
</head>
<body>
<h1>JWT-плейлист</h1>
<video id="player" width="640" controls autoplay muted></video>

<script>
    const player = document.getElementById("player");

    fetch("/media")
        .then(r => r.json())
        .then(async list => {
            const tokenUrls = await Promise.all(
                list.map(async name => {
                    const resp = await fetch(`/token/media/${name}/token`);
                    const { token } = await resp.json();
                    return `/token/media/signed/${token}`;
                })
            );

            let idx = 0;
            function play(i) {
                player.src = tokenUrls[i];
                player.play().catch(()=>{});
            }

            player.addEventListener("ended", () => {
                idx = (idx + 1) % tokenUrls.length;
                play(idx);
            });

            play(idx);
        })
        .catch(console.error);
</script>
</body>
</html>
